<!DOCTYPE html>

<head>
  <title>Mégra Visualizer</title>
  <meta charset="UTF-8" />        
  <script src="/node_modules/osc/dist/osc-browser.js"></script>
  <script src="/node_modules/d3/dist/d3.js"></script>
  <script src="/node_modules/dagre-d3/dist/dagre-d3.js"></script>  
</head>

<style>

  svg {
      border: 0px;
      overflow: hidden;
  }

  .node {
      white-space: nowrap;
  }

  .node rect,
  .node circle,
  .node ellipse {
      stroke: #ffffff;
      fill: #fff;
      stroke-width: 1.5px;
  }
  
  .edgePath path {
      stroke: #ffffff;
      stroke-width: 1.5px;
      fill: none;
      border: 0.5px;
      border-color: #999999;
  }

  body {
      font-family: Comic Mono, monospace;
      background: #000000;
      font-size: 8pt;
  }
  
  h1 {
      font-size: 12pt;
      color: #ffffff;
  }
  
  label {
      margin-top: 1em;
      display: block;
  }
  
</style>

<body>

  <h1>Current Mégra Session !</h1>
  
</body>

<script>

  // Create and configure the renderer (well, not much to configure so far)
  var render = dagreD3.render();
  var graphlib = dagreD3.graphlib;

  // keep graphs and svgs here ...
  var graphs = {};
  var graph_svgs = {};
  var last_active = {};
  var last_label = {};

  function renderSingle(name) {
      console.log("render " + name);

      if(!graph_svgs.hasOwnProperty(name)) {
          graph_svgs[name] = d3.select("body")
	      .append("svg")                                  
	      .attr("id", name);
          graph_svgs[name].append("g");                                                                                                      
      }

      var inner = graph_svgs[name].select("g"); 
      inner.call(render, graphs[name]);
      // Center the graph

      graph_svgs[name].attr("width", graphs[name].graph().width + 80).attr("height", graphs[name].graph().height + 80);
      var xCenterOffset = (graph_svgs[name].attr("width") - graphs[name].graph().width) / 2;
      inner.attr("transform", "translate(" + xCenterOffset + ", 20)");
  }
  
  function renderAll() {
      Object.keys(graphs).forEach(function(key) {
	  renderSingle(key);	  
      });
  };
    
  var oscPort = new osc.WebSocketPort({
      url: "ws://localhost:8081", // URL to your Web Socket server.
      metadata: true
  });
  
  oscPort.open();

  oscPort.on("message", function (msg) {

      switch(msg.address) {
      case "/graph/add": {
	  var name = msg.args[0].value;	  	  
	  graphs[name] = new graphlib.Graph().setGraph({});
	  console.log("add graph " + name);
	  break;
      }
      case "/node/add": {
	  var name = msg.args[0].value;
	  var node_id = msg.args[1].value;
	  var node_label = msg.args[2].value.trim();

	  console.log("add node " + node_id + " with label " + node_label + " to graph " + name);

	  if(!graphs.hasOwnProperty(name)) {
	      graphs[name] = new graphlib.Graph().setGraph({});
	  }

	  graphs[name].setNode(node_id, {
	      label: node_label,
	      style: "fill: #afa",
	      shape: 'ellipse'
	  });
	  
	  break;
      }
      case "/node/active": {
	  var name = msg.args[0].value;	  	  

	  if(graphs.hasOwnProperty(name)) {
	      var src = msg.args[1].value;
	      var label = msg.args[2].value.trim();
	      
	      if(last_active.hasOwnProperty(name)) {
		  graphs[name].setNode(last_active[name], {
		      label: last_label[name],
		      style: "fill: #afa",
		      shape: 'ellipse'
		  });
	      }
	      
	      graphs[name].setNode(src, {
		  label: label,
		  style: "fill: #f77",
		  shape: 'ellipse'
	      });
	      
	      last_active[name] = src;
	      last_label[name] = label;

	      renderSingle(name);
	  }
	  break;
      }
      case "/edge/add": {
	  var name = msg.args[0].value;
	  var src = msg.args[1].value;
	  var dest = msg.args[2].value;

	  console.log("add edge " + src + " -> " + dest + " to graph " + name);

	  if(!graphs.hasOwnProperty(name)) {
	      graphs[name] = new graphlib.Graph().setGraph({});
	  }
	  
	  graphs[name].setEdge(src, dest, {	      
	      curve: d3.curveBasis 
	  });

	  break;
      }
      case "/render": {	  	  
	  renderSingle(msg.args[0].value);	  
	  break;
      }
      case "/clear": {	  	  
	  var name = msg.args[0].value;
	  if(graph_svgs.hasOwnProperty(name)) {
	      graph_svgs[name].remove();
	      delete graph_svgs[name];
	  }
	  if(graphs.hasOwnProperty(name)) {	      
	      delete graphs[name];
	  }
	  break;
      }
      }            
  });
  
</script>
