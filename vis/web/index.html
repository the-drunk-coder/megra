<!DOCTYPE html>

<head>
  <title>Mégra Visualizer</title>
  <meta charset="UTF-8" />        
  <script src="/node_modules/osc/dist/osc-browser.js"></script>
  <script src="/node_modules/d3/dist/d3.js"></script> 
</head>

<style>
  body {
      font-family: Comic Mono, monospace;
      background: #000;
      font-size: 6pt;
  }
  
  svg {
      border: 0px;
      overflow: hidden;
  }
  
  path.link {
      fill: none;
      stroke: #fff;
      stroke-width: 1.5px;
  }

  circle {
      fill: #fff;
      stroke: #fff;
      stroke-width: 1.5px;
  }

  text {
      fill: #000;
      font: 10px sans-serif;
      pointer-events: none;
  }

  h1 {
      font-size: 12pt;
      color: #ffffff;
  }
  
</style>

<body>

  <h1>Current Mégra Session !</h1>
  
</body>

<script>
  
  // keep graphs and svgs here ...
  var graphs = {};
  var layouts = {};
  var graph_svgs = {};
  var last_active = {};
  var last_label = {};

  function fixna(x) {
      if (isFinite(x)) return x;
      return 0;
  }

  function linkArc(d) {
      const r = Math.hypot(d.target.x - d.source.x, d.target.y - d.source.y);
      return `
    M${d.source.x},${d.source.y}
    A${r},${r} 0 0,1 ${d.target.x},${d.target.y}
  `;
  }

  drag = simulation => {
      
      function dragstarted(d) {
	  if (!d3.event.active) simulation.alphaTarget(0.3).restart();
	  d.fx = d.x;
	  d.fy = d.y;
      }
      
      function dragged(d) {
	  d.fx = d3.event.x;
	  d.fy = d3.event.y;
      }
      
      function dragended(d) {
	  if (!d3.event.active) simulation.alphaTarget(0);
	  d.fx = null;
	  d.fy = null;
      }
      
      return d3.drag()
	  .on("start", dragstarted)
	  .on("drag", dragged)
	  .on("end", dragended);
  }
  
  function renderSingle(name) {      
      var width = 960;
      var height = 500;

      var force = d3.forceSimulation(graphs[name].nodes)
	  .force("link", d3.forceLink(graphs[name].links).id(d => d.id))
	  .force("charge", d3.forceManyBody().strength(-400))
	  .force("center", d3.forceCenter(width / 2, height / 2))
	  .force("x", d3.forceX())
	  .force("y", d3.forceY());
      
      var svg = d3.select("body").append("svg")
	  .attr("width", width)
	  .attr("height", height);
      
      // Per-type markers, as they don't inherit styles.
      svg.append("defs").selectAll("marker")          
	  .join("marker")
	  .attr("id", "arrow-all")
	  .attr("viewBox", "0 -5 10 10")
	  .attr("refX", 15)
	  .attr("refY", -0.5)
	  .attr("markerWidth", 6)
	  .attr("markerHeight", 6)
	  .attr("orient", "auto")
	  .append("path")
	  .attr("fill", "#fff")    
	  .attr("d", "M0,-5L10,0L0,5");
      
      var link = svg.append("g")
	  .attr("fill", "none")	  
	  .attr("stroke-width", 1.5)      	  
	  .selectAll("path")
	  .data(graphs[name].links)
	  .join("path")
	  .attr("stroke", "#fff")
	  .attr("marker-end", "url(${new URL(#arrow-all, location)})");

      var node = svg.append("g")
	  .attr("fill", "currentColor")
	  .attr("stroke-linecap", "round")
	  .attr("stroke-linejoin", "round")
	  .selectAll("g")
	  .data(graphs[name].nodes)
	  .join("g")
	  .call(drag(force));
      
      node.append("circle")
	  .attr("stroke", "white")
	  .attr("stroke-width", 1.5)
	  .attr("r", 15)
      	  
      node.append("text")
	  .attr("x", 0)
	  .attr("y", 0)
	  .text(d => d.label)
	  .clone(true).lower()
	  .attr("fill", "none")
	  .attr("stroke", "white")
	  .attr("stroke-width", 3);

      force.on("tick", () => {
	  link.attr("d", linkArc);
	  node.attr("transform", d => `translate(${d.x},${d.y})`);
      });

      invalidation.then(() => force.stop());

      graph_svgs[name] = svg;
      layouts[name] = force;
  }
  
  var oscPort = new osc.WebSocketPort({
      url: "ws://localhost:8081", // URL to your Web Socket server.
      metadata: true
  });
  
  oscPort.open();

  oscPort.on("message", function (msg) {

      switch(msg.address) {
      case "/graph/add": {
	  var name = msg.args[0].value;
	  
	  console.log("add graph: " + name);

	  graphs[name] = {};
	  
	  graphs[name].nodes = [];
	  graphs[name].links = [];
	  
	  break;
      }
      case "/node/add": {
	  var graph_name = msg.args[0].value;
	  var node_id = msg.args[1].value;
	  var node_label = msg.args[2].value.trim();

	  console.log("add node with id " + node_id + " and label " + node_label + " to graph: " + graph_name);
	  
	  graphs[graph_name]['nodes'].push({id: node_id, label: node_label})
	  
	  break;
      }
      case "/node/active": {
	  var name = msg.args[0].value;	  	  

	  if(graphs.hasOwnProperty(name)) {
	      var src = msg.args[1].value;
	      var label = msg.args[2].value.trim();
	      
	      
	  }
	  break;
      }
      case "/edge/add": {
	  var name = msg.args[0].value;
	  var src = msg.args[1].value;
	  var dest = msg.args[2].value;
	  var label = msg.args[3].value;
	  var prob = msg.args[4].value;
	  
	  console.log("add edge " + src + " -> " + dest + " to graph " + name + " label " + label + " prob " + prob );

	  if(graphs.hasOwnProperty(name)) {
	      graphs[name].links.push ({
		  source: src,
		  target: dest,
	      });	      
	  }
	  
	  break;
      }
      case "/render": {
	  var name = msg.args[0].value;

	  if(graphs.hasOwnProperty(name)) {
	      renderSingle(name);
	  }
	  
	  break;
      }
      case "/clear": {	  	  
	  var name = msg.args[0].value;
	  
	  break;
      }
      }            
  });
  
</script>
