<!DOCTYPE html>

<head>
  <title>Mégra Visualizer</title>
  <meta charset="UTF-8" />        
  <script src="/node_modules/osc/dist/osc-browser.js"></script>
  <script src="/node_modules/cytoscape/dist/cytoscape.min.js"></script> 
</head>

<style>
  body {
      font-family: Comic Mono, monospace;
      color: #fff;
      background: #000;
      font-size: 12px;
  }
  
  #cy {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      right: 0;
      z-index: 999;
  }
  
  h1 {
      opacity: 0.5;
      font-size: 1em;
      font-weight: bold;
  }
  
</style>

<body>

  <h1>Current Mégra Session !</h1>
  
  <div id="cy"></div>
  
</body>

<script>
  var layouts = {};
  var edges = {};
  var nodes = {};
  var last_active = {};

  // calculate edge thickness from probablity
  function thickness(prob) {
      return 0.2 + (3.0 * (prob / 100.0));
  }
  
  var oscPort = new osc.WebSocketPort({
      url: "ws://localhost:8081", // URL to your Web Socket server.
      metadata: true
  });
  
  oscPort.open();
  
  oscPort.on("message", function (msg) {

      switch(msg.address) {
      case "/graph/add": {
	  var name = msg.args[0].value;

	  if(!edges.hasOwnProperty(name)){
	      edges[name] = {};
	  }
	  if(!nodes.hasOwnProperty(name)){
	      nodes[name] = {};
	  }
	  if(!edges[name].hasOwnProperty('current')){
	      edges[name]['current'] = [];
	  }
	  if(!nodes[name].hasOwnProperty('current')){
	      nodes[name]['current'] = [];
	  }
	  
	  edges[name]['added'] = [];
	  nodes[name]['added'] = [];

	  if(!layouts.hasOwnProperty(name)) {

	      layouts[name] = cytoscape({
		  container: document.getElementById('cy'),
		  style: [
		      {
			  selector: 'node',
			  style: {
			      'background-color': '#afa',
			      'color' : '#fff',
			      'font-family' : 'Comic Mono, monospace',
			      'shape': 'ellipse',
			      'content': 'data(name)'
			  }
		      },
		      {
			  selector: ':selected',
			  style: {
			      'background-color': '#f77',
			      'color' : '#fff',			      
			  }
		      },
		      {
			  selector: 'edge',
			  style: {
			      'curve-style': 'bezier',
			      'target-arrow-shape': 'triangle',
			      'width' : 'data(width)',
			      'content' : 'data(label)',
			      'font-family' : 'Comic Mono, monospace',
			      'color' : '#fff',
			  }
		      },
		  ]
	      });
	  }
	  
	  break;
      }
      case "/node/add": {
	  var name = msg.args[0].value;
	  var node_id = 'n' + msg.args[1].value;
	  var node_label = msg.args[2].value.trim();

	  var n = layouts[name].$('#' + node_id);
	  if(n.length > 0) {
	      n.data("name", node_label);
	  } else {
	      layouts[name].add([{
		  group: "nodes",
		  data: {
		      id: node_id,
		      name: node_label
		  }
	      }]);
	  }
	  nodes[name].added.push(node_id);
	  
	  break;
      }
      case "/node/active": {
	  var name = msg.args[0].value;	  	  

	  if(layouts.hasOwnProperty(name)) {
	      var src = msg.args[1].value;
	      layouts[name].$(last_active[name]).unselect();
	      layouts[name].$('#n' + src).select();
	      last_active[name] = '#n' + src;
	  }
	  
	  break;
      }
      case "/edge/add": {
	  var name = msg.args[0].value;
	  var src = msg.args[1].value;
	  var dest = msg.args[2].value;
	  var label = msg.args[3].value;
	  var prob = msg.args[4].value;

	  var edge_id = 'edge-n' + src + '-n' + dest;

	  var e = layouts[name].$('#' + edge_id);
	  if(e.length > 0) {
	      e.data("label", label);
	      e.data("width", thickness(prob));
	  } 

	  edges[name].added.push({
	      group: "edges",
	      data: {
		  id: edge_id,  // giving edges an id helps avoid duplicates
		  source: 'n' + src,
		  target: 'n' + dest,
		  width: thickness(prob),
		  label: label
	      }
	  });
	  
	  
	  break;
      }
      case "/render": {	  
	  var name = msg.args[0].value;
	  var layout = msg.args[1].value.toLowerCase();	  


	  console.log(layout)
	  
	  nodes[name].current.forEach(function(nid) {
	      if(!nodes[name].added.includes(nid)) {
		  layouts[name].$('#' + nid).remove();
	      }
	  });

	  nodes[name].current = nodes[name].added.slice();
	  
	  edges[name].current.forEach(function(edge) {
	      if(!edges[name].added.includes(edge)) {
		  layouts[name].$('#' + edge.data.id).remove();
	      }
	  });

	  edges[name].current = edges[name].added.slice();

	  layouts[name].add(edges[name].current);
	  
	  layouts[name].layout( {
	      name: layout 
	  }).run();
	 
	  break;
      }
      case "/clear": {	  	  
	  var name = msg.args[0].value;

	  layouts[name].destroy();
	  delete layouts[name];
	  
	  break;
      }
      }            
  });
  
</script>
